---
reviewed:  2023-08-01 11:35:44
title:     Craft CMS tuning
naviTitle: Tuning
excerpt:   Domain setup, security keys, https, dev mode …
lead:      Tips, tricks, best practices and advanced topics on how to run Craft CMS successfully on fortrabbit.
sidebar:      craft
structureNav: true
head:
  meta:
    - name: 'keywords'
      content: 'craft, craftCMS, setup, install-guide'
---

<!-- TODO: Review, old stuff! -->

## Get ready

Make sure to have followed our Craft [setup](/3.craft/1.setup.md) and [deployment](/3.craft/2.deployment.md) so far.

## Security key setup

<!-- TODO: Check if it is actually in use. Frank 2023-07-29 20:27:53: Can not find much reference of security key with Craft 4 any more. It's an ENV var still. -->

The mandatory Craft CMS security key has to be shared among all environments. We recommend to use your local security key as the master key. When you used Composer to install, that key was shown at the end of the installation. If not, open your local (hidden) `.env` file from the root folder of your project and find a line that looks like this:

```dotenv
CRAFT_SECURITY_KEY=69UzZSEquw9E7RdCyRRTRb1lxe7h0EPd
```

It will contain a value if you have installed Craft CMS correctly on your local machine. Copy that line. Go to the App's ENV vars settings in the dashboard and paste that line. That ENV var is already set. Just replace it with your local one.

:DashboardLink{title="Edit ENV vars for asdads" path="/new/app" text="dashboard.fortrabbit.com/environments/ASDASD/settings/env-vars"}

## Multi-environment configuration

Craft embraces the idea of storing environment specific configurations in ENV vars. You can create groups in every config file. The top level array key maps with the `CRAFT_ENVIRONMENT` constant, which defaults to the `CRAFT_ENVIRONMENT` ENV var. With this flexible approach you decide which configurations are under version control to share with your team and which are not. We assume fortrabbit to be your production environment, so the `CRAFT_ENVIRONMENT` ENV var is set to `production` on remote and locally to `dev`.

```dotenv
# Local environment ENV 
CRAFT_ENVIRONMENT=dev
```

## Domain setup

Your fortrabbit app comes with a predefined app environment name and a URL like `{{app-env-name}}.frb.io` — which is good for testing. At some point you will very likely add your own domains.

For general information on how to add domains to your fortrabbit App, please see our [domains article](/14.tips/dns-external-domains.md). For Craft CMS be sure to have set your domain's root path to the `/web` folder.

When installing Craft locally, it will ask you which domain you want to use. This local domain differs form the one you want to use in production. That's why it is stored in the `PRIMARY_SITE_URL` ENV var. The installer creates this ENV var in the .env file. In your fortrabbit production environment you may need to set `PRIMARY_SITE_URL` using the ENV var settings of your App.

Craft CMS uses `@web` alias internally when it deals with HTTP requests. Unless you define it, Craft will try to figure it out based on HTTP headers - which is not always possible. It's good practice to define it explicitly using `PRIMARY_SITE_URL` ENV var.

```php
return [
  // Recommended aliases in config/general.php
  'aliases' => [
    '@web' => \craft\helpers\App::env('PRIMARY_SITE_URL') ?: '/',
    '@webroot' => dirname(__DIR__) . '/web'
  ],
];
```

You can also add multiple domains. From the fortrabbit side, just point them to the App's root path, configure routing and display of contents within Craft CMS and/or use additional [htaccess rules](/htaccess).

## Multi site domain settings

For multi-site setups, you may need to hard-code the domains for each environment. Here is an example of that:

```php
return [
  // fortrabbit (multi site)
  'production' => [
    'siteUrl' => [
      'en' => '//www.site.com',
      'nl' => '//www.site.nl',
    ],
  ],
  // local (multi site)
  'dev' => [
    'siteUrl' => [
      'en' => '//en.site.dev',
      'nl' => '//nl.site.dev',
    ],
  ],
];
```

## Using .htaccess for redirects and to force https

Craft CMS comes with a [predefined `.htaccess` file](https://github.com/craftcms/craft/blob/main/web/.htaccess) that lives inside the `web` folder. You can extend that with your own rules, like forwarding all requests to https or disabling access on the App URL. Please see our [.htaccess articles](/14.tips/6.htaccess/index.md) for examples.

## X-Powered-By headers

<!-- TODO: Are we still using x-powered by headers? -->

You probably think it's a good idea to disable headers that expose which PHP version and CMS you use. And we think so too!

However, internally we analyze this header to determine if it is a static or dynamic PHP response. With this information we generate two different metrics for the dashboard: PHP requests and Static requests.
In `config/general.php` you can disable the header with `'sendPoweredByHeader' => false,` (default: true). This is not required, since we strip all `X-Powered-By` headers eventually.

## Using project config

Craft will create multiple project config files in the `/config/project` directory. We advice to apply changes, each time you deploy, see our [Craft deployment article](/3.craft/2.deployment.md).

<!-- With the [fortrabbit/craft-auto-migrate](https://github.com/fortrabbit/craft-auto-migrate) package, Project Config changes are applied automatically every time you `git push` changes. -->

## Enabling dev mode

Sometime while developing you might want to see some error output directly on your browser screen. That's what the `devMode` flag is for. See the [Craft docs](https://craftcms.com/knowledge-base/what-dev-mode-does) for more details.

## Don't allow updates in production

Craft CMS has the option to run updates directly from the Craft Control Panel. A client or editor might be tempted to use that update button in production. This is not a good idea. On fortrabbit Git is a one-way street, so any changes on the App itself can not easily be ported back to the local development environment. Also `composer update` might be triggered on the App and that can lead to performance problems.

So it's better to prevent the shiny "update" button from showing up at all. You can do that in your Craft configuration in the general settings with the `allowUpdates` flag.

## Don't allow admin changes in production

We highly recommend not making any admin changes to your production environment (fortrabbit) at all. Only do editorial changes. Have one single source of truth and only one direction (up). Please also see the official [Craft CMS docs](https://craftcms.com/docs/config/config-settings.html#allowadminchanges) on that.

Otherwise you can run into trouble: Imagine you make changes to the database structure, by adding tables for example, changing the field layout in production. Now you don't have the changes locally. But you deploy other new changes from local to production. This might overwrite the `project.yml` in production and therefore will roll back your changes. Your local development should be your master in applying design and functional changes.

## Change the control panel URL

"Security through obscurity" is a widely discussed concept. We suggest to obscure the control panel URL of your Craft installation, just because you can. Do so with the `cpTrigger` setting. If you don't set this value it defaults to `admin`.

```php
return [
  'cpTrigger' => 'godmode'
];
```

## MySQL table prefixes

If your local Craft installation contains a table prefix, the one on the fortrabbit App should be the same. You can set the table prefix, locally in your `.env` file, and on fortrabbit with the App's [ENV vars](/#craft-config-example) like so:

```apache [.env]
# Example Table prefix
CRAFT_DB_TABLE_PREFIX=craft_
```

## Manually setting ENV vars

Our [Software Preset](/12.platform/software-presets.md) will populate the ENV vars on fortrabbit for you (see [here](/env-vars) for more on ENV vars). So if you didn't choose the Craft preset when creating the App, or you are just curious how this works, or your ENV vars have been deleted accidentally, here is what will be set:

### Craft ENV vars on fortrabbit

```apache [.env]
CRAFT_DB_DRIVER=mysql
CRAFT_DB_PASSWORD=${MYSQL_PASSWORD}
CRAFT_DB_DSN=mysql:host=${MYSQL_HOST};port=3306;dbname=${MYSQL_DATABASE}
CRAFT_ENVIRONMENT=production
CRAFT_SECURITY_KEY=LongRandomString
```

## Using Craft CMS plugins

We highly recommend to not install plugins directly on your production App. Instead install plugins locally first, then [deploy](/6.deployment/1.intro.md) to get them installed on the app as well.

### A) Install Craft plugins from the control panel

This method let's you conveniently discover, install and also "activate" (pay for) the plugins right in place.

1. Visit the control panel of your local Craft installation
2. Visit the plugin store
3. Search, install and activate plugins

Plugins installed via the plugin store are "pinned" with `composer.json` and must also be updated through the same mechanisms. Please also see our [updating instructions](/craft-update).

### B) Install Craft plugins via command line

This is a more advanced method to install plugins directly from the command line:

```shell
# 1. Add the plugin to Composer:
$ composer require {vendor/package-name}

# 2. Install the plugin via Craft CLI
$ ./craft plugin/install {plugin-handle}
```

Plugins installed that way can be updated with `composer update` later on. Please also see our updating instructions.

## Using image tuning plugins

Image uploads to Craft are usually getting processed by ImageMagick. Image transformations happen when original images are sized down into several delivery formats. That happens during upload for display in the Craft Control Panel but also in your templates when you want to show those images to the users. Nowadays with image media queries like `srcset` one needs not only two sizes (thumbnail and large) but all kind of different sizes for different device resolutions. Please keep in mind that image transforms are "expensive" in terms of CPU utilization. Best don't overdo it. Use only as much as you'll need. Maybe four sizes per image are enough, for the imager plugin that can be four steps. The image format `webp` is supported with fortrabbit's imageMagick version.

### jpegoptim and company

[Some people suggest](https://nystudio107.com/blog/creating-optimized-images-in-craft-cms) further optimizing images with jpegoptim or optipng. These tools are not available here on fortrabbit. We advise using dedicated specialized third party image optimization services, like imgix, tinypng, kraken to do the job best.

## Craft CLI

Craft CMS comes with a built in command line interface which can be called from the console. You can also run it one the app environment itself like so:

```shell
# Call Craft CLI via php
php craft
```

Not all Craft CLI commands are safe to run in production. Our recommendations:

* `setup/*` — Don't, intended to run locally only
* `update/*` — Don't, if you deploy using git or using project config
* `clear-caches/*` — Don't, unless you have a good reason
* `resave/*` — Sometimes needed
* `project-config/sync` — Only needed if it's not part of your deployment
* `migrate/all` — Only needed if it's not part of your deployment
* `backup/db` — Useful to make a database backup. Can harm performance
* `restore/db` — Useful if you need to revert the DB to a previous state

## Logging

By default Craft CMS is piping PHP errors to `storage/logs/web.log`. The Craft CMS stream log location can be set to `stderr` and `stdout` by setting the [environment variable](/11.concepts/env-vars.md) `CRAFT_STREAM_LOG=true`. This is pre-populated when choosing Craft CMS in the [software chooser](/11.concepts/software-presets.md) while creating the app. When the ENV var is present and true, Craft CMS error logs can be accessed through the fortrabbit dashboard. See our [log article](/11.concepts/logs.md) for more details.

## Queue jobs

Craft CMS uses queue jobs for long-running tasks. By default these jobs are processed by a web based ajax call which blocks PHP processes that are meant for site delivery. In the worst case scenario the queue runner consumes all PHP resources. Luckily there are more robust solutions available:

### 1. Workers

Run long running processes in a isolated environment without hurting site delivery with the [workers component](/10.components/7.workers.md).

1. Set up a job with this Craft command: `php craft queue/listen -v`
2. Remove `runQueueAutomatically` from `config/general.php` to disable the standard queue

### 2. Async Queue plugin

For most queue workloads the `ostark/craft-async-queue` plugin mitigates the problems described above. There is no further configuration required, just install it like any other plugin. See the [guide on Github](https://github.com/ostark/craft-async-queue) to understand what it does. Consider it a poor mans worker.

## Sending mail

You can not use sendmail on fortrabbit - see our [quirks article](/11.concepts/4.quirks.md). Craft CMS allows your to configure sending mail via SMTP. It includes options to set your SMTP host, port, and credentials. You can use environment variables there as well. It's also possible to do that configuration within the Craft control panel. Our recommendation: Use an external third party transactional mail provider for that. Pixel & Tonic (Craft CMS creators) maintain a [plugin for Postmark](https://plugins.craftcms.com/postmark). With that plugin installed you can easily set it up.

## Licensing Craft CMS

Craft CMS is not all free. To enable the good parts you need to obtain a licence from Pixel & Tonic (the folks building Craft CMS). A Craft CMS license is limited to a single domain, which means you can only access the Craft CP with one domain - otherwise you'll see a warning. You might have used the fortrabbit App URL for development and you might have used that to connect your Craft CMS licence with. You can change the domain of a Craft licence as well, if for instance you started with our App URL but now want to use your own domain with your Craft ID — over at <https://id.craftcms.com/>.

## Craft storage folder

We found a couple of Craft CMS installations blowing up the storage folder. This is often related to plugins and configuration. Some search engine bot might try to crawl all pages, causing a faceted search plugin to create gigabytes of template fragments. Some other plugin may just write very verbose logs. Best, make sure to configure your website to not cause such issues, beside the web storage, such issues have impact on performance.
