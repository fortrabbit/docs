---
reviewed: 2023-07-08 13:59:28
title: Laravel tuning
naviTitle: Tuning
navigation.excerpt: Configure and run
lead: Configure Laravel to run on fortrabbit most optimally.
sidebar: laravel
nextNav: true
structureNav: true
head:
  meta:
    - name: keywords
      content: laravel, redis, sendmail, emoji, envoyer, artisan down, queueing
---

<!-- TODO: Review, correct, maybe remove more! -->

## Get ready

You have already started your Laravel on fortrabbit journey with the [setup](/2.laravel/1.setup.md) and continued over [deployment](/2.laravel/2.deployment.md). This is the final article to address most common configuration options to successfully run Laravel based applications on fortrabbit.

## Emoji support

<!-- TODO: Review by infra! -->

Laravel uses the `utf8mb4` character set by default, which includes support for storing "emojis ðŸ”¥" in the database. You need to manually configure the default string length generated by migrations in order for MySQL to create indexes for them in your `AppServiceProvider`:

```php
use Illuminate\Support\Facades\Schema;

/**
 * Bootstrap any application services.
 *
 * @return void
 */
public function boot()
{
  Schema::defaultStringLength(191);
}
```

## Manually running artisan migrate

While it's recommended to [run database migrations automated](/2.laravel/2.deployment.md#migration-build-step) each time you deploy, you can also do that manually. Log in by [SSH](/7.code-access/3.ssh.md) and execute `artisan`:

```shell
# login and execute
$ ssh {{ssh-user}}@deploy.{{region}}.frbit.com
$ php artisan migrate --force
```

**Note**: If `APP_ENV` is set to `production` - which is the default - the `--force` flag for migrate commands will override the confirmation prompt. You can also add this command to your `composer.json` to have it run automatically every time you push changes.

```json [composer.json]
"scripts": {  
  "post-install-cmd": [
    "php artisan migrate --no-interaction --force",
  ],
}
```

With that in place, any time you deploy your code, database changes will be applied immediately. If no database changes are required, nothing happens, so it is safe to run all the time. Just make sure to test your upgrades and migrations locally first.

## Logging

<!-- TODO: Review this with care! Is it really possible to alter an ENV var to output this? Otherwise provide exact settings -->

Logs for Laravel are stored in `storage/logs` per default. Our [software preset](/11.concepts/software-presets.md) for Laravel however pre-configures log output to `stderr` and `stdout` so the logs become available in the dashboard - see the [logging article](/11.concepts/logs.md).

If for some reason you can not access the logs in the dashboard, see if you can access these via [SSH](/7.code-access/3.ssh.md) or [SFTP](/7.code-access/4.sftp.md).

See [Laravel logging help](https://laravel.com/docs/logging) for more.

## User sessions

There are various session drivers available in Laravel. Whichever driver you end up using, will need to be specified in the environment variables. Add a new ENV var `SESSION_DRIVER` in the dashboard and give it the appropriate value. Since fortrabbit app environments have persistent storage, you are able to use the default `file` driver for sessions.

To use the `database` driver, follow these steps:

```shell
# Create a migration for the session table  - locally
$ php artisan session:table

# Apply the migration - locally
$ php artisan migrate

# Add, commit and push the migration file
$ git add .
$ git commit -m "session migration"
$ git push

# Run the migration on the App via SSH remote execution
$ ssh {{ssh-user}}@deploy.{{region}}.frbit.com php artisan migrate --force
```

## Queueing

Laravel supports multiple queue drivers. One which can be used with fortrabbit out of the box is `database`, which simply uses your database connection as a queue:

```shell
# Create a migration for the jobs table locally
php artisan queue:table 

# Apply the migration locally
$ php artisan migrate

# Add, commit and push the migration file
$ git add .
$ git commit -m "queue migration"
$ git push

# Run the migration on the App via SSH remote execution
$ ssh {{ssh-user}}@deploy.{{region}}.frbit.com php artisan migrate --force
```

That's great for small use-cases and tinkering, but if your App handles very many queue messages you should consider Redis.

Once you've decided the queue you want to use, just open `config/queue.php` and set `default` to either `redis`, `database`, `sqs` - or even better: set the `QUEUE_CONNECTION` environment variable accordingly in the dashboard.

To run `php artisan queue:work` in the background, spin up a new [Worker](/9.components/7.workers.md) and define the artisan command as a job.

**NB**: Laravel offers two commands to process queues: `queue:work` and `queue:listen`. We recommend using `queue:work`, and *not* using `queue:listen`. This is because the `queue:listen` command boots the Laravel framework for each iteration, whereas `queue:work` boots the framework once and runs as a daemon. Using `queue:work` offers high memory and performance gains in comparison with `queue:listen`.

## Working with Redis

Redis can be used in Laravel as a cache or a queue or both. fortrabbit does not offer a Redis service of its own. To use Redis, you will need to book an externally-hosted Redis service.

1. On the fortrabbit side, turn on the Redis extension
2. Then setup an account with a Redis provider.
3. Then configure the redis database connection in `config/database.php`:

```php
$redis = [
  'host'     => env('REDIS_HOST', 'localhost'),
  'password' => env('REDIS_PASSWORD', null),
  'port'     => env('REDIS_PORT', 6379),
  'database' => 0,
];

return [
  // other code â€¦
  'redis' => [
    'cluster' => false,
    'default' => $redis
  ],
  // other code â€¦
];
```

If you plan on using Redis as a cache, then open `config/cache.php` and set the `CACHE_DRIVER` environment variable to `redis`.

<!-- 

TODO: Write something about scheduling, Worker or Cron?

## Scheduling

-->

## Using artisan down

`artisan down` generates the file `storage/framework/down`, which is then checked from your App's HTTP kernel with the `CheckForMaintenanceMode` middleware. You can run the command run the command via [SSH](/7.code-access/3.ssh.md) or during deployment.

## Using Laravel Envoy

Easy. Here is an `Envoy.blade.php` example:

```php
@servers(['fr' => '{{ssh-user}}@deploy.{{region}}.frbit.com'])

@task('ls', ['on' => 'fr'])
  ls -lha
@endtask

@task('migrate', ['on' => 'fr'])
  php artisan migrate
@endtask
```

Then execute locally:

```shell
envoy run ls
envoy run migrate
```

## Sending mail

You can not use [sendmail](/11.concepts/4.quirks.md) on fortrabbit but Laravel provides an API over the popular SwiftMailer library. The mail configuration file is `app/config/mail.php`, and contains options allowing you to change your SMTP host, port, and credentials, as well as set a global form address for all messages delivered by the library.
